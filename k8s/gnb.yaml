apiVersion: v1
kind: Service
metadata:
  name: gnb
  namespace: nextg-system
  labels:
    app.kubernetes.io/name: gnb
    app.kubernetes.io/part-of: nextgsim
spec:
  selector:
    app.kubernetes.io/name: gnb
  ports:
    - name: rls
      port: 4997
      targetPort: 4997
      protocol: UDP
    - name: gtpu
      port: 2152
      targetPort: 2152
      protocol: UDP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gnb
  namespace: nextg-system
  labels:
    app.kubernetes.io/name: gnb
    app.kubernetes.io/part-of: nextgsim
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: gnb
  template:
    metadata:
      labels:
        app.kubernetes.io/name: gnb
        app.kubernetes.io/part-of: nextgsim
    spec:
      initContainers:
        - name: wait-amf
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z amf.nextg-system.svc.cluster.local 38412; do echo waiting for amf ngap; sleep 2; done']
      containers:
        - name: gnb
          image: nextgsim/gnb:latest
          imagePullPolicy: IfNotPresent
          args: ["-c", "/etc/nextgsim/gnb.yaml"]
          ports:
            - containerPort: 4997
              name: rls
              protocol: UDP
            - containerPort: 2152
              name: gtpu
              protocol: UDP
          env:
            - name: RUST_LOG
              value: "info,nextgsim_gnb=debug,nextgsim_sctp=debug,nextgsim_ngap=debug,nextgsim_gtp=debug"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi
          volumeMounts:
            - name: config
              mountPath: /etc/nextgsim/gnb.yaml
              subPath: gnb.yaml
              readOnly: true
          readinessProbe:
            exec:
              command: ["pgrep", "-f", "nr-gnb"]
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            exec:
              command: ["pgrep", "-f", "nr-gnb"]
            initialDelaySeconds: 15
            periodSeconds: 30
      volumes:
        - name: config
          configMap:
            name: nextgsim-configs
